# Google Cloud Build configuration for Cloud Run deployment
steps:
  # 1. Container Image OluÅŸtur (Build)
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '-t'
      - 'gcr.io/$PROJECT_ID/smartsupport-backend:$COMMIT_SHA'
      - '-t'
      - 'gcr.io/$PROJECT_ID/smartsupport-backend:latest'
      - '.'

  # 2. Container Image'Ä± KayÄ±t Defterine GÃ¶nder (Push)
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - 'gcr.io/$PROJECT_ID/smartsupport-backend:$COMMIT_SHA'

  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - 'gcr.io/$PROJECT_ID/smartsupport-backend:latest'

  # 3. Cloud Run'a Deploy Et (KRÄ°TÄ°K AYARLAR BURADA)
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
      - 'beta'  # 'beta' komutlarÄ±nÄ± kullanmak daha gÃ¼venli (no-cpu-throttling iÃ§in)
      - 'run'
      - 'deploy'
      - 'smartsupport-backend'
      - '--image'
      - 'gcr.io/$PROJECT_ID/smartsupport-backend:$COMMIT_SHA'
      - '--region'
      - 'europe-west3'
      - '--platform'
      - 'managed'
      - '--port'
      - '8080'
      # ðŸ‘‡ DÃœZELTÄ°LEN AYARLAR ðŸ‘‡
      - '--memory'
      - '8Gi'          # 4Gi YERÄ°NE 8Gi YAPTIK
      - '--cpu'
      - '2'
      - '--min-instances'
      - '1'            # SoÄŸuk baÅŸlangÄ±cÄ± Ã¶nlemek iÃ§in
      - '--max-instances'
      - '1'            # KOTA AÅžMAMAK Ä°Ã‡Ä°N 10 YERÄ°NE 1 YAPTIK
      - '--no-cpu-throttling' # Worker Ã§alÄ±ÅŸsÄ±n diye CPU'yu kesme dedik
      - '--vpc-connector'
      - 'redis-connector'     # Redis'e ulaÅŸabilmesi iÃ§in kÃ¶prÃ¼yÃ¼ ekledik
      # ðŸ‘† DÃœZELTÄ°LEN AYARLAR BÄ°TTÄ° ðŸ‘†
      - '--allow-unauthenticated'

images:
  - 'gcr.io/$PROJECT_ID/smartsupport-backend:$COMMIT_SHA'
  - 'gcr.io/$PROJECT_ID/smartsupport-backend:latest'

options:
  machineType: 'E2_HIGHCPU_8'
  logging: CLOUD_LOGGING_ONLY

timeout: '3600s'